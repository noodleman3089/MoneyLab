import pandas as pd

# 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î" ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
# (‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏°‡∏≠‡∏á" ‡∏Ç‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1)
# --- [UPDATED] ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ---
KEYWORD_MAP = {
    # ‡∏´‡∏°‡∏ß‡∏î: ‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    '‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°': ['GrabFood', 'LINE MAN', 'Foodpanda', 'Robinhood', 
                           'Starbucks', 'Amazon Cafe', 'KFC', 'McDonald', 'Pizza',
                           '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 'food'],

    # ‡∏´‡∏°‡∏ß‡∏î: ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
    '‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á': ['‡∏õ‡∏ï‡∏ó', 'PTT', 'Shell', '‡∏ö‡∏≤‡∏á‡∏à‡∏≤‡∏Å', 'Caltex', 
                     '‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô', 'Easy Pass', 'BTS', 'MRT', 'Bolt', 'Grab',
                     'Agoda', 'Traveloka', 'Booking.com', 'AirAsia'],
    
    # ‡∏´‡∏°‡∏ß‡∏î: ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢/‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ
    '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢/‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ': ['‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', '‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏õ‡∏≤', 'MEA', 'MWA', '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü', '‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥', 
                                 'AIS Fibre', 'True Online', '3BB', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï', '‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'],
    
    # ‡∏´‡∏°‡∏ß‡∏î: ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
    '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û/‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á': ['‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', '‡∏£‡∏û.', '‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å', '‡πÄ‡∏†‡∏™‡∏±‡∏ä', 'Watsons', 'Boots', 'Fascino', '‡∏£‡πâ‡∏≤‡∏ô‡∏¢‡∏≤',
                               '‡∏ö‡∏≤‡∏£‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå', 'barber', '‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡∏î‡∏ú‡∏°', '‡∏ó‡∏≥‡∏ú‡∏°', '‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏ß‡∏¢'],
    
    # ‡∏´‡∏°‡∏ß‡∏î: ‡πÑ‡∏•‡∏ü‡πå‡∏™‡πÑ‡∏ï‡∏•‡πå/‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á
    '‡πÑ‡∏•‡∏ü‡πå‡∏™‡πÑ‡∏ï‡∏•‡πå/‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á': ['7-Eleven', '7-11', 'Lotus', 'Big C', 'Tops', 'Gourmet Market',
                           'Shopee', 'Lazada', 'Tiktok', 'Central', 'The Mall', 'Robinson',
                           'Major', 'SF Cinema', 'Netflix', 'Spotify', 'YouTube', 'Disney+', 'Viu'],

    # ‡∏´‡∏°‡∏ß‡∏î: ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    '‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á': ['B2S', '‡∏ã‡∏µ‡πÄ‡∏≠‡πá‡∏î', '‡∏ô‡∏≤‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå', 'Kinokuniya', 'Udemy', 'Coursera', 'SkillLane',
                             '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏°', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢'],

    # ‡∏´‡∏°‡∏ß‡∏î: ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    '‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô': ['AIA', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÑ‡∏ó‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', 'FWD', '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°', '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°', '‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠', '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢']
}


class RuleBasedPredictor:
    
    def __init__(self):
        # ‡πÄ‡∏£‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏à‡∏ô‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô
        self.rules = []
        for category, keywords in KEYWORD_MAP.items():
            for keyword in keywords:
                self.rules.append((keyword.lower(), category)) # ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô (‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å, ‡∏´‡∏°‡∏ß‡∏î)

    def predict(self, transaction_data):
        """
        ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 1 ‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏õ‡πá‡∏ô dict) ‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢
        """
        
        # 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Text ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        # (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ù‡∏±‡πà‡∏á)
        receiver = str(transaction_data.get('receiver_name', '')).lower()
        sender = str(transaction_data.get('sender_name', '')).lower()
        
        text_to_check = f"{receiver} {sender}"
        
        # 2. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î
        for keyword, category in self.rules:
            if keyword in text_to_check:
                # ‡πÄ‡∏à‡∏≠‡∏õ‡∏∏‡πä‡∏ö! ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                return {
                    'predicted_category_name': category, # üëà [THE FIX] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Key
                    'confidence': 0.95, # ‡πÄ‡∏£‡∏≤‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÉ‡∏ô Rule ‡πÄ‡∏™‡∏°‡∏≠
                    'method': 'rule_based_keyword',
                    'need_ml': False # ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
                }
                
        # 3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡πÄ‡∏•‡∏¢
        return {
            'predicted_category_name': None, # üëà [THE FIX] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Key
            'confidence': 0.0,
            'method': 'rule_based_failed',
            'need_ml': True # "‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ ML ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£!"
        }